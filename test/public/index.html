<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件传输测试工具</title>
    <style>
      :root {
        --primary: #4361ee;
        --success: #06d6a0;
        --warning: #ffd166;
        --danger: #ef476f;
        --dark: #1e293b;
        --light: #f8f9fa;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 800px;
        overflow: hidden;
      }

      header {
        background: var(--primary);
        color: white;
        padding: 25px 30px;
        text-align: center;
      }

      h1 {
        font-size: 2.2rem;
        margin-bottom: 8px;
      }

      .subtitle {
        opacity: 0.9;
        font-weight: 300;
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 30px;
        padding: 25px;
        border-radius: 12px;
        background: var(--light);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      h2 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
      }

      h2 i {
        margin-right: 12px;
        font-size: 1.4rem;
      }

      .upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: var(--primary);
        background: rgba(67, 97, 238, 0.05);
      }

      .upload-area i {
        font-size: 3rem;
        color: var(--primary);
        margin-bottom: 15px;
      }

      .file-input {
        display: none;
      }

      .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn i {
        margin-right: 8px;
      }

      .btn:hover {
        background: #3651d8;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-download {
        background: var(--success);
      }

      .btn-download:hover {
        background: #05b388;
        box-shadow: 0 4px 8px rgba(6, 214, 160, 0.3);
      }

      .progress-container {
        margin: 25px 0;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: var(--dark);
      }

      .progress-bar {
        height: 12px;
        background: #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
      }

      .progress {
        height: 100%;
        background: var(--primary);
        border-radius: 6px;
        width: 0%;
        transition: width 0.3s;
      }

      .download .progress {
        background: var(--success);
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
        margin: 10px 0;
      }

      .download .stat-value {
        color: var(--success);
      }

      .stat-label {
        color: #64748b;
        font-size: 0.9rem;
      }

      .result {
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        text-align: center;
        font-weight: 500;
        display: none;
      }

      .success {
        background: rgba(6, 214, 160, 0.15);
        color: var(--success);
        border: 1px solid var(--success);
      }

      .error {
        background: rgba(239, 71, 111, 0.15);
        color: var(--danger);
        border: 1px solid var(--danger);
      }

      footer {
        text-align: center;
        padding: 20px;
        color: #64748b;
        font-size: 0.9rem;
        border-top: 1px solid #e2e8f0;
      }

      @media (max-width: 600px) {
        .content {
          padding: 20px 15px;
        }

        .section {
          padding: 20px;
        }

        .stats {
          flex-direction: column;
          gap: 15px;
        }

        h1 {
          font-size: 1.8rem;
        }
      }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>

  <body>
    <div class="container">
      <header>
        <h1>文件传输测试工具</h1>
        <p class="subtitle">测试上传与下载速度，计算平均传输速率</p>
      </header>

      <div class="content">
        <div class="section upload">
          <h2><i class="fas fa-cloud-upload-alt"></i> 文件上传测试</h2>

          <div class="upload-area" id="dropArea">
            <i class="fas fa-file-upload"></i>
            <p>拖放文件到此处或点击选择文件</p>
            <p class="small">支持任意类型的文件，推荐使用较大文件测试速度</p>
          </div>

          <input type="file" class="file-input" id="fileInput">

          <div class="progress-container">
            <div class="progress-info">
              <span>状态: <span id="uploadStatus">等待上传</span></span>
              <span>速度: <span id="uploadSpeed">0 MB/s</span></span>
            </div>
            <div class="progress-bar">
              <div class="progress" id="uploadProgress"></div>
            </div>
          </div>

          <button class="btn" id="uploadBtn">
            <i class="fas fa-upload"></i> 开始上传
          </button>

          <div class="result" id="uploadResult"></div>
        </div>

        <div class="section download">
          <h2><i class="fas fa-cloud-download-alt"></i> 文件下载测试</h2>

          <p>下载已上传的文件测试下载速度</p>

          <div class="progress-container">
            <div class="progress-info">
              <span>状态: <span id="downloadStatus">等待下载</span></span>
              <span>速度: <span id="downloadSpeed">0 MB/s</span></span>
            </div>
            <div class="progress-bar">
              <div class="progress" id="downloadProgress"></div>
            </div>
          </div>

          <button class="btn btn-download" id="downloadBtn">
            <i class="fas fa-download"></i> 开始下载
          </button>

          <div class="result" id="downloadResult"></div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-label">平均上传速度</div>
            <div class="stat-value" id="avgUploadSpeed">0 MB/s</div>
            <div class="stat-label">上次测试结果</div>
          </div>

          <div class="stat-card">
            <div class="stat-label">平均下载速度</div>
            <div class="stat-value" id="avgDownloadSpeed">0 MB/s</div>
            <div class="stat-label">上次测试结果</div>
          </div>
        </div>
      </div>

      <footer>
        <p>文件传输测试工具 &copy; 2023 | 文件存储位置: <span id="storagePath"></span></p>
      </footer>
    </div>

    <script>
      // 页面元素
      const dropArea = document.getElementById('dropArea')
      const fileInput = document.getElementById('fileInput')
      const uploadBtn = document.getElementById('uploadBtn')
      const downloadBtn = document.getElementById('downloadBtn')
      const uploadProgress = document.getElementById('uploadProgress')
      const downloadProgress = document.getElementById('downloadProgress')
      const uploadStatus = document.getElementById('uploadStatus')
      const downloadStatus = document.getElementById('downloadStatus')
      const uploadSpeed = document.getElementById('uploadSpeed')
      const downloadSpeed = document.getElementById('downloadSpeed')
      const uploadResult = document.getElementById('uploadResult')
      const downloadResult = document.getElementById('downloadResult')
      const avgUploadSpeed = document.getElementById('avgUploadSpeed')
      const avgDownloadSpeed = document.getElementById('avgDownloadSpeed')
      const storagePath = document.getElementById('storagePath')

      // 状态变量
      let selectedFile = null
      let uploadStartTime, downloadStartTime
      let lastUploadSpeed = 0
      let lastDownloadSpeed = 0

      // 显示服务器存储路径（简化示例）
      storagePath.textContent = window.location.hostname

      // 拖放功能
      dropArea.addEventListener('dragover', (e) => {
        e.preventDefault()
        dropArea.classList.add('dragover')
      })

      dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('dragover')
      })

      dropArea.addEventListener('drop', (e) => {
        e.preventDefault()
        dropArea.classList.remove('dragover')

        if (e.dataTransfer.files.length) {
          handleFileSelect(e.dataTransfer.files[0])
        }
      })

      dropArea.addEventListener('click', () => {
        fileInput.click()
      })

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleFileSelect(e.target.files[0])
        }
      })

      // 处理文件选择
      function handleFileSelect(file) {
        selectedFile = file
        uploadStatus.textContent = `已选择: ${file.name} (${formatFileSize(file.size)})`
        uploadResult.style.display = 'none'
      }

      // 上传文件
      uploadBtn.addEventListener('click', async () => {
        if (!selectedFile) {
          showResult(uploadResult, '请先选择文件', 'error')
          return
        }

        try {
          uploadStartTime = Date.now()
          const formData = new FormData()
          formData.append('file', selectedFile)

          // 重置状态
          uploadProgress.style.width = '0%'
          uploadStatus.textContent = '上传中...'
          uploadSpeed.textContent = '计算中...'
          uploadResult.style.display = 'none'

          const xhr = new XMLHttpRequest()

          // 进度事件
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100
              uploadProgress.style.width = `${percent}%`

              // 计算当前速度
              const elapsed = (Date.now() - uploadStartTime) / 1000 // 秒
              const speed = e.loaded / elapsed / (1024 * 1024) // MB/s
              uploadSpeed.textContent = `${speed.toFixed(2)} MB/s`
            }
          })

          // 完成事件
          xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
              const elapsed = (Date.now() - uploadStartTime) / 1000
              const speed = selectedFile.size / elapsed / (1024 * 1024)
              lastUploadSpeed = speed
              avgUploadSpeed.textContent = `${speed.toFixed(2)} MB/s`

              uploadStatus.textContent = '上传完成'
              showResult(uploadResult, `上传成功! 平均速度: ${speed.toFixed(2)} MB/s`, 'success')
            } else {
              uploadStatus.textContent = '上传失败'
              showResult(uploadResult, `上传失败: ${xhr.statusText}`, 'error')
            }
          })

          // 错误事件
          xhr.addEventListener('error', () => {
            uploadStatus.textContent = '上传失败'
            showResult(uploadResult, '上传过程中发生错误', 'error')
          })

          xhr.open('POST', '/upload')
          xhr.send(formData)

        } catch (error) {
          showResult(uploadResult, `上传错误: ${error.message}`, 'error')
        }
      })

      // 下载文件
      downloadBtn.addEventListener('click', async () => {
        try {
          downloadStartTime = Date.now()
          const url = '/upload.txt?t=' + new Date().getTime() // 避免缓存

          // 重置状态
          downloadProgress.style.width = '0%'
          downloadStatus.textContent = '下载中...'
          downloadSpeed.textContent = '计算中...'
          downloadResult.style.display = 'none'

          const response = await fetch(url)

          if (!response.ok) {
            throw new Error(`下载失败: ${response.status} ${response.statusText}`)
          }

          const contentLength = response.headers.get('content-length')
          if (!contentLength) {
            throw new Error('无法获取文件大小')
          }

          const total = parseInt(contentLength, 10)
          let loaded = 0

          const reader = response.body.getReader()
          const chunks = []

          while (true) {
            const { done, value } = await reader.read()
            if (done) break

            chunks.push(value)
            loaded += value.length

            // 更新进度
            const percent = (loaded / total) * 100
            downloadProgress.style.width = `${percent}%`

            // 计算当前速度
            const elapsed = (Date.now() - downloadStartTime) / 1000 // 秒
            const speed = loaded / elapsed / (1024 * 1024) // MB/s
            downloadSpeed.textContent = `${speed.toFixed(2)} MB/s`
          }

          // 完成下载
          const elapsed = (Date.now() - downloadStartTime) / 1000
          const speed = total / elapsed / (1024 * 1024)
          lastDownloadSpeed = speed
          avgDownloadSpeed.textContent = `${speed.toFixed(2)} MB/s`

          downloadStatus.textContent = '下载完成'
          showResult(downloadResult, `下载成功! 平均速度: ${speed.toFixed(2)} MB/s`, 'success')

          // 创建下载链接
          const blob = new Blob(chunks)
          const downloadUrl = URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = downloadUrl
          a.download = 'upload.txt'
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)
          URL.revokeObjectURL(downloadUrl)

        } catch (error) {
          downloadStatus.textContent = '下载失败'
          showResult(downloadResult, `下载错误: ${error.message}`, 'error')
        }
      })

      // 显示结果消息
      function showResult(element, message, type) {
        element.textContent = message
        element.className = 'result ' + type
        element.style.display = 'block'
      }

      // 格式化文件大小
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B'
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB'
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB'
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB'
      }
    </script>
  </body>

</html>
